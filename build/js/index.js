(()=>{"use strict";const e={callback:null,isCalling:!1,proxySymbol:Symbol("isProxy"),recorderValue:null,getProxyHandler:(t={},r="data")=>({get:(n,o,s)=>{let i=Reflect.get(n,o,s);if("symbol"!=typeof o&&"function"!=typeof i&&e.callback){const n=`${r}.${o}`;t[n]||(t[n]=[]),t[n].includes(e.callback)||t[n].push(e.callback)}return e.recorderValue||(e.recorderValue={set(i){Reflect.set(n,o,i,s),e.handCalls(t,`${r}.${o}`)}}),"symbol"!=typeof o&&Object.hasOwn(n,o)&&("[object Object]"!==Object.prototype.toString.call(i)||Object.hasOwn(i,e.proxySymbol)||(i=new Proxy(i,e.getProxyHandler(t,`${r}.${o}`)),Reflect.set(n,o,i,s),i[e.proxySymbol]=!0)),i},set:(n,o,s,i)=>{if(Reflect.get(n,o,i)===s&&"length"!==o)return!0;const l=Reflect.set(n,o,s,i);return"symbol"!=typeof o&&e.handCalls(t,`${r}.${o}`),l},deleteProperty(n,o,s){const i=Reflect.deleteProperty(n,o,s);return"symbol"!=typeof o&&Reflect.has(n,o,s)&&e.handCalls(t,`${r}.${o}`),i}}),handCalls(t,r){if(e.isCalling)return;e.isCalling=!0;const n=[];Object.entries(t).forEach((([e,t])=>{0===e.indexOf(r)&&n.push(...t)})),setTimeout((()=>{n.forEach((t=>{e.callback=t,t(),e.callback=null})),e.isCalling=!1}))},getProxyData:t=>"function"==typeof t?t:"object"==typeof t&&null!==t?new Proxy(t,e.getProxyHandler()):new Proxy({value:t},e.getProxyHandler())},t=e,r="ontouchstart"in document,n=["SCRIPT","STYLE"],o=document.createElement("div"),s=class{root=null;data={};dataKeys=[];isRendered=!1;rendered=[];forData={};ifConditions=[];preIfElement=null;bufferCallbacks=new Set;constructor(e,t){this.root=e,this.data=t,this.dataKeys=Object.keys(t),"loading"===window.document.readyState?document.addEventListener("DOMContentLoaded",(()=>{this.renderRoot()})):this.renderRoot()}renderRoot(){this.renderNode(this.root),this.isRendered=!0,this.rendered.forEach((e=>e()))}renderNode(e){const{nodeName:t}=e;if(!n.includes(t))if("#text"===e.nodeName)this.renderText(e);else{if(e.attributes&&this.renderAttr(e))return;e.childNodes&&[...e.childNodes].forEach((e=>{this.renderNode(e)}))}}renderText(e){let t,r=e;for(;null!==(t=r.data.match(/\{.*?\}/));){0!==t.index&&(r=r.splitText(t.index));const e=r.splitText(t[0].length);this.renderTextCotnt(r,r.data.slice(1,-1)),r=e}}renderTextCotnt(e,t){const r=this.getValueFun(t);this.setLsnrctlCallback((()=>{const t=r();void 0===t?e.data="":["object","function"].includes(typeof t)?e.data=JSON.stringify(t):e.data=t}),e)}renderAttr(e){const t={},r={},n={},o={};if(e.attributes&&[...e.attributes].forEach((e=>{const[s,...i]=e.name.split(".");s.length<=1||(":"===s[0]?t[e.name]=[s.slice(1),i,e.value]:"@"===s[0]?r[e.name]=[s.slice(1),i,e.value]:"-"===s[0]?n[e.name]=[s.slice(1),i,e.value]:"+"===s[0]&&(o[e.name]=[s.slice(1),i,e.value]))})),this.renderSpecials(e,n))return!0;this.renderBinds(e,t),this.renderEvents(e,r),this.renderRetains(e,o)}renderBinds(e,t){Object.entries(t).forEach((([t,[r,n,o]])=>{e.removeAttribute(t),["INPUT","SELECT"].includes(e.tagName.toUpperCase())&&":"===r[0]?this.renderBindForMutual(e,r.slice(1),o,n):"class"===r?this.renderBindForClass(e,o,n):"style"===r?this.renderBindForStyle(e,o,n):this.renderBindForNormal(e,r,o,n)}))}renderBindForNormal(e,t,r){const n=this.getValueFun(r);this.setLsnrctlCallback((()=>{const r=n();"string"==typeof r||0===t.indexOf("data-")?e.setAttribute(t,r):e[t]=r}),e)}renderBindForClass(e,t){const{className:r}=e,n=this.getValueFun(t);this.setLsnrctlCallback((()=>{let t=r;const o=n();"[object Object]"===Object.prototype.toString.call(o)?Object.entries(o).forEach((([e,r])=>{r&&(t+=` ${e}`)})):t+=` ${o}`,e.className=t}),e)}renderBindForStyle(e,t){const r=e.getAttribute("style")||"",n=this.getValueFun(t);this.setLsnrctlCallback((()=>{let t=r;const o=n();"[object Object]"===Object.prototype.toString.call(o)?Object.entries(o).forEach((([e,r])=>{if("transform"===e&&"[object Object]"===Object.prototype.toString.call(r)){let n="";Object.entries(r).forEach((([e,t])=>{n+=`${e}(${t}) `})),t+=`${e}:${n};`}else t+=`${e}:${r};`})):t+=o,e.setAttribute("style",t)}),e)}renderBindForMutual(e,t,r){const n=e.tagName.toUpperCase();"INPUT"===n?this.renderBindForMutualOfInput(e,t,r):"SELECT"===n&&this.renderBindMutualOfSelect(e,t,r)}renderBindForMutualOfInput(e,r,n){const o=this.getValueFun(n);let s=null,i="";if("checkbox"===e.type){i="change";const r=o(),n=e.getAttribute("value")||e.value;if("[object Array]"===Object.prototype.toString.call(r))this.setLsnrctlCallback((()=>{e.checked=r.includes(n)}),e),s=()=>{if(e.checked&&!r.includes(n))r.push(n);else if(!e.checked&&r.includes(n)){const e=r.indexOf(n);r.splice(e,1)}};else if("[object Object]"===Object.prototype.toString.call(r)){const t=e.getAttribute("value")||e.value;this.setLsnrctlCallback((()=>{e.checked=r[t]}),e),s=()=>{r[t]=e.checked}}else t.recorderValue=null,this.setLsnrctlCallback((()=>{e.checked=o()}),e),t.recorderValue&&(s=t.recorderValue.set)}else"radio"===e.type?(i="change",t.recorderValue=null,this.setLsnrctlCallback((()=>{e.checked=o()===e.value}),e),t.recorderValue&&(s=t.recorderValue.set)):(i="input",t.recorderValue=null,this.setLsnrctlCallback((()=>{e.value=o()}),e),t.recorderValue&&(s=t.recorderValue.set));e.addEventListener(r||i,(()=>{s&&s()}))}renderBindForMutualOfSelect(e,r,n){const o=this.getValueFun(n);if(t.recorderValue=null,this.setLsnrctlCallback((()=>{e.value=o()}),e),t.recorderValue){const n=t.recorderValue.set;e.addEventListener(r||"change",(()=>{n&&n()}))}}renderEvents(e,t){Object.entries(t).forEach((([t,[r,n,o]])=>{e.removeAttribute(t),"down"===r?this.renderEventForDown(e,o,n):"up"===r?this.renderEventForUp(e,o,n):"clk"===r?this.renderEventForClk(e,o,n):"dbclk"===r?this.renderEventForDbclk(e,o,n):"move"===r?this.renderEventForMove(e,o,n):this.renderEventForNormal(e,r,o,n)}))}renderEventForDown(e,t,n){r?this.renderEventForNormal(e,"touchstart",t,n):this.renderEventForNormal(e,"mousedown",t,n)}renderEventForUp(e,t,n){r?this.renderEventForNormal(e,"touchend",t,n):this.renderEventForNormal(e,"mouseup",t,n)}renderEventForClk(e,t,n){if(r){const r=this.getValueFun(t);let o=!0,s=0;this.renderEventForNormal(e,"touchstart",(()=>{o=!1,s=Date.now()}),n),this.renderEventForNormal(e,"touchmove",(()=>{o=!0})),this.renderEventForNormal(e,"touchend",(()=>{Date.now()-s<=150&&!o&&r()}),n)}else this.renderEventForNormal(e,"click",t,n)}renderEventForDbclk(e,t,n){if(r){const r=this.getValueFun(t);let o=0,s=0;this.renderEventForNormal(e,"touchstart",(e=>{e.preventDefault(),e.returnValue=!1,o++,1===o&&(s=setTimeout((()=>{o=0}),500))}),n),this.renderEventForNormal(e,"touchend",(e=>{e.preventDefault(),e.returnValue=!1,o++,1===o?o=0:4===o&&(clearTimeout(s),o=0,r(e))}),n)}else this.renderEventForNormal(e,"dbclick",t,n)}renderEventForMove(e,t,n){if(r){const r=this.getValueFun(t);let o=0,s=0;this.renderEventForNormal(e,"touchstart",(e=>{e.preventDefault(),e.returnValue=!1,o++,1===o&&(s=setTimeout((()=>{o=0}),500))}),n),this.renderEventForNormal(e,"touchend",(e=>(e.preventDefault(),e.returnValue=!1,o++,1===o?o=0:4===o&&(clearTimeout(s),o=0,r(e)),!1)),n)}else this.renderEventForNormal(e,"dbclick",t,n)}renderEventForNormal(e,t,r){const n=this.getValueFun(r)();e.addEventListener(t,n)}renderSpecials(e,t){Object.entries(t).forEach((([t,[r,n,o]])=>{e.removeAttribute(t);let s=!1;if("for"===r?s=this.renderSpecialForFor(e,o,n):"if"===r?s=this.renderSpecialForIf(e,o,n):"elif"===r?s=this.renderSpecialForElif(e,o,n):"else"===r?s=this.renderSpecialForElse(e,n):"show"===r&&(s=this.renderSpecialForShow(e,o,n)),s)return!0}))}renderSpecialForFor(e,r){const[n,o]=r.split(" in "),[s,i]=n.split(","),l=document.createComment("render.for");e.parentNode.insertBefore(l,e),e.parentNode.removeChild(e);const a=this.getValueFun(o),c=[];let d;return this.setLsnrctlCallback((()=>{d=a();const r="number"==typeof d,n=r?d:d.length;if(t.callback=null,n>c.length)for(let t=c.length;t<n;t++){this.forKeys.push(s),r?this.forValues.push((()=>t)):"object"==typeof d[t]?this.forValues.push((()=>d[t])):this.forValues.push((()=>({get value(){return d[t]},set value(e){d[t]=e}}))),i&&(this.forKeys.push(i),this.forValues.push((()=>t)));const n=e.cloneNode(!0);c.push(n),l.parentNode.insertBefore(n,l),this.renderNode(n),this.forKeys.pop(),this.forValues.pop(),i&&(this.forKeys.pop(),this.forValues.pop())}else if(n<c.length){for(let e=n;e<c.length;e++)c[e].parentNode.removeChild(c[e]);c.length=n}}),e),!0}renderSpecialForIf(e,t){const r=this.getValueFun(t),n=document.createComment("if");e.parentNode.insertBefore(n,e),this.ifConditions=[r],this.preIfElement=[e,n],this.setLsnrctlCallback((()=>{r()?n.parentNode.insertBefore(e,n):e.parentNode&&e.parentNode.removeChild(e)}),e)}renderSpecialForElif(e,t){const r=this.getValueFun(t);let{previousSibling:n}=e;for(;"#text"==n.nodeName;)n=n.previousSibling;if(!n||!this.preIfElement.includes(n))return void console.error("-elif属性节点位置错误",e);const o=document.createComment("elif");e.parentNode.insertBefore(o,e);const s=[...this.ifConditions];this.ifConditions.push(r),this.preIfElement=[e,o],this.setLsnrctlCallback((()=>{s.find((e=>e()))||!r()?e.parentNode&&e.parentNode.removeChild(e):o.parentNode.insertBefore(e,o)}),e)}renderSpecialForElse(e){let{previousSibling:t}=e;for(;"#text"==t.nodeName;)t=t.previousSibling;if(!t||!this.preIfElement.includes(t))return void console.error("-else属性节点位置错误",e);const r=document.createComment("elif");e.parentNode.insertBefore(r,e);const n=[...this.ifConditions];this.ifConditions=[],this.preIfElement=null,this.setLsnrctlCallback((()=>{n.find((e=>e()))?e.parentNode&&e.parentNode.removeChild(e):r.parentNode.insertBefore(e,r)}),e)}renderSpecialForShow(e,t){const r=this.getValueFun(t),{display:n}=e.style;this.setLsnrctlCallback((()=>{r()?e.style.display=n:e.style.display="none"}),e)}renderRetains(e,t){"[object Object]"!==Object.prototype.toString.call(e.retainAttrs)&&(e.retainAttrs={}),Object.entries(t).forEach((([t,[r,n,o]])=>{e.retainAttrs[r]=this.getValueFun(o)(),e.removeAttribute(t)}))}setLsnrctlCallback(e,r){t.callback=()=>{const{bufferCallbacks:t}=this;document.contains(this.root)?(t.size&&(t.forEach((e=>e())),t.clear()),e()):t.add(e)},e(),t.callback=null}getValueFun(e){return o.setAttribute("onclick",`return ({${this.dataKeys.join(",")}}, {${Object.keys(this.forData).join(",")}}) => ${e||"undefined"}`),o.onclick().bind(window,this.data,this.forData)}},i={istype:(e,...t)=>{const r=Object.prototype.toString.call(e).slice(8,-1).toUpperCase();return t.some((e=>e.toUpperCase()===r))}},{istype:l}=i,a=document.createElement("style");document.head.appendChild(a);let c=null;const d=({name:e,html:r="",data:n=(()=>{}),style:o=""})=>{if(!l(e,"string"))return void console.error("Compoment的name参数应该存在并为string类型");if(!l(r,"string"))return void console.error("Compoment的html参数应该存在并为string类型");if(!l(n,"function"))return void console.error("Compoment的data参数应为 object 或 () => object 类型");if(!l(o,"string"))return void console.error("Compoment的style参数应该存在并为string类型");if(customElements.get(e))return;o&&(a.innerHTML+=o.replace(/\s+/g," "));const i=e.includes("-")?e.toLowerCase():`app-${e.toLowerCase()}`,d=r.trim().replace(/((?<=<\s?)[A-Z](?=(.*?)\b[^>]*\/?>)|(?<=<\s?\/\s?)[A-Z](?=(.*?)\b[^>]*>))/g,(e=>`app-${e.toLowerCase()}`));customElements.define(i,class extends HTMLElement{connectedCallback(){const e=t.getProxyData(n()||{});c=e,l(e.init,"function")&&e.init(this.retainAttrs||{});const r=document.createRange().createContextualFragment(d).childNodes[0];if(new s(r,e),c=null,l(e.rendered,"function")){const t=[...r.querySelectorAll("[ref]")].reduce(((e,t)=>(e[t.getAttribute("ref")]=t,t.removeAttribute("ref"),e)),{});setTimeout((()=>{e.rendered(t)}))}this.parentNode.insertBefore(r,this),this.parentNode.removeChild(this)}})};t.getProxyData({});const u=(()=>{let e=[];const r={},n=t.getProxyData([]),o=t.getProxyData({}),i=t.getProxyData({});{const e=(location.href.match(/(?<=#\/).*?(?=(\?|$))/)||[""])[0],t=(location.href.split("?")[1]||"").split("&").reduce(((e,t)=>{const[r,n]=t.split("=");return e[r]=n,e}),{});Object.entries(t).forEach((([e,r])=>{o[e]=t[e]}));const r=e.split("/");n.push(...r)}return window.addEventListener("hashchange",(t=>{const i=`${(t.newURL.match(/(?<=#\/).*?(?=(\?|$))/)||[""])[0]}/`,l=`${(t.oldURL.match(/(?<=#\/).*?(?=(\?|$))/)||[""])[0]}/`,a=(t.newURL.split("?")[1]||"").split("&").reduce(((e,t)=>{const[r,n]=t.split("=");return e[r]=n,e}),{});if(Object.entries(o).forEach((([e,t])=>{a.hasOwnProperty(e)?t!==a[e]&&(o[e]=a[e]):delete o[e]})),Object.entries(a).forEach((([e,t])=>{o.hasOwnProperty(e)||(o[e]=a[e])})),i===l)return;const c=i.split("/").slice(0,-1);c&&c.forEach(((e,t)=>{e!=n[t]&&(n[t]=e)})),n.length=c.length;const d=Object.entries(r).reduce(((e,[t,r])=>(0==i.indexOf(t)&&e.push(...r),e)),[]);d.forEach((t=>{e.includes(t)||(t.isRendered||(new s(t.routerRoot,t.data),t.isRendered=!0),t.routerAnchor.parentNode.insertBefore(t.routerRoot,t.routerAnchor))})),e.forEach((e=>{d.includes(e)||e.routerRoot.parentNode.removeChild(e.routerRoot)})),e=d})),customElements.define("app-router",class extends HTMLElement{constructor(){super();const t=`${this.getAttribute("path")}/`||"/";this.removeAttribute("path");const n=document.createComment("router");this.parentNode.insertBefore(n,this),this.parentNode.removeChild(this);const o=document.createElement("div"),s=document.createRange().createContextualFragment(this.innerHTML.trim());o.appendChild(s),[...this.attributes].forEach((({name:e,value:t})=>o.setAttribute(e,t)));const i={routerAnchor:n,routerRoot:o,data:c,isRendered:!1};0==`${(location.hash.match(/(?<=#\/).*?(?=(\?|$))/)||[""])[0]}/`.indexOf(t)&&(n.parentNode.insertBefore(o,n),i.isRendered=!0,e.push(i)),r.hasOwnProperty(t)||(r[t]=[]),r[t].push(i)}}),{query:o,params:i,path:n,to:({path:e,query:t,params:r})=>{const n=l(t,"Object")?`?${Object.entries(t).map((([e,t])=>`${e}=${t}`)).join("&")}`:"";location.hash=`#/${e}${n}`,l(i,"Object")&&Object.entries(i).forEach((([e,t])=>{r.hasOwnProperty(e)?t!==r[e]&&(i[e]=r[e]):delete i[e]})),l(r,"Object")&&Object.entries(r).forEach((([e,t])=>{i.hasOwnProperty(e)||(i[e]=r[e])}))}}})();d({name:"app-Demo",html:'<div>\n    <canvas ref="cvs1" width="300" height="300"></canvas>\n    <canvas ref="cvs2" width="300" height="300"></canvas>\n</div>',style:"",data:()=>({rendered({cvs1:e,cvs2:t}){const r=e.getContext("2d"),n=t.getContext("2d");{const t=new Image;t.src="imgs/apic27858.jpg",t.addEventListener("load",(()=>{r.drawImage(t,0,0,300,300);const o=r.getImageData(0,0,300,300).data;e.addEventListener("click",(e=>{const t=[...r.getImageData(e.offsetX,e.offsetY,1,1).data],s=[];for(let e=0;e<o.length;e+=4){const r=o.slice(e,e+4);Math.abs(t[0]-r[0])+Math.abs(t[1]-r[1])+Math.abs(t[2]-r[2])<100?s.push(...t):s.push(1,1,1,255)}n.putImageData(new ImageData(new Uint8ClampedArray(s),300,300),0,0)}))}))}}})}),d({name:"app-Root",html:'<div class="root">\n    <h1 class="logo">{currentLogos}</h1>\n    <div class="line"></div>\n    <a href="link" class="title">title</a>\n    <button @clk="gotoRouter">goto router</button>\n    <Router path="router">\n        <p>{currentLogos}</p>\n        <Demo />\n    </Router>\n</div>',style:" * { padding: 0; margin: 0; } body { width: 100%; height: 100vh; display: flex; justify-content: center; background-color: #345; align-items: center; } .root { display: flex; justify-content: center; align-items: center; flex-direction: column; } .logo { position: relative; font-size: 20vmin; pointer-events: none; user-select: none; } .line { width: 0; height: 1vmin; border-right: 20vmin solid #0000; border-left: 0vmin solid #789; animation: line 3s linear infinite; } @keyframes line { 100% { border-right: 0 solid #789; border-left: 20vmin solid #0000; } } .title { color: #eee; font-size: 5vmin; text-decoration: none; transition: letter-spacing 0.5s; } .title:hover { letter-spacing: 0.05em; } ",data(){const e=["🥪","🍧","🍰","🍟","🌮","🥠","🍚","🍜","🍨","🥧"];return{currentLogos:"🥪",init(t){let r=0;setInterval((()=>{r++,r>=e.length&&(r=0),this.currentLogos=e[r]}),1e3)},gotoRouter(){u.to({path:"router"})}}}}),(({root:e,component:t})=>{if(!l(e,"string"))return void console.error("render的root参数应该存在并为string类型");if(!l(t,"string"))return void console.error("render的component参数应该存在并为string类型");const r=document.querySelector(e);r?r.appendChild(document.createElement(t)):console.error(`无法获取到元素: ${e}`)})({root:"#root",component:"app-root"})})();